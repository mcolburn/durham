% Package: ocmc-liturgical-text
% Author: Michael Colburn
% specifies packages and defines new commands for purposes
% of typesetting liturgical books for the Eastern Orthodox Christian Church
% 
% the prefix 'lt' means 'liturgical text'.  This prefix was added to commands to avoid collisions with commands named by other packages.
%
% This package relies on package i18n-topic-key.
% This package dynamically loads a topic file
% when a key is requested.  It only loads it once.
% This package dynamically loads fonts for
% topics that have a language code of ara (Arabic), chu (Church Slavonic), or heb (Hebrew).
%
% TODO
% - Add ltSetColumnSep width, rule width
% - way to set sloppy sloppy spaces. currently hardcode when doing 2 or 3 columns
% - way to set root folder for resources

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ocmc-liturgical-text}[2016/08/11 Formatting of Eastern Orthodox Christian Liturgical Texts]

\usepackage{silence}
\WarningsOff*
%\WarningFilter{latex}{You have requested Package}

\def\my{/ocmc/liturgical/text}% use as pgfkeys path prefix
\def\myLoadedResources{\my/resources/loaded}%
\def\myLoadedFonts{\my/fonts/loaded}%
\def\ltSystemPath{system}

\RequirePackage{etoolbox}%

%=======================================
% PACKAGE OPTIONS
%=======================================
%% Show keys option
\newbool{debugKeys}%
\boolfalse{debugKeys}%
\DeclareOption{debug}{%
    \booltrue{debugKeys}%
}
%% clear babel option
\newbool{clearbabel}%
\boolfalse{clearbabel}%
\DeclareOption{clearbabel}{%
    \booltrue{clearbabel}%
}
%% hyphenation option
\newbool{hyphenate}%
\boolfalse{hyphenate}%
\DeclareOption{hyphenate}{%
    \booltrue{hyphenate}%
}
%% Show realm option
\newbool{showRealm}%
\boolfalse{showRealm}%
\DeclareOption{showrealm}{%
    \booltrue{showRealm}%
}
%% Support Korean option
\newbool{supportKorean}%
\boolfalse{supportKorean}%
\DeclareOption{korean}{%
    \booltrue{supportKorean}%
}

\ProcessOptions*
\ifbool{debugKeys}{%
    \RequirePackage[debug]{system/i18n-topic-key}%
}{%
    \RequirePackage{system/i18n-topic-key}%
}

%=====================================%===========
% Packages
%================================================
\RequirePackage{etex}
\usepackage{microtype} % Improves character and word spacing
\usepackage{comment} % comment out lines with \begin{comment} ... \end{comment}
\usepackage{ragged2e} % so margins can be ragged
\usepackage{titlesec}
\usepackage{parskip}
\usepackage{titling}
\usepackage{trimspaces}
\usepackage[margin=1in]{geometry}%
\usepackage{color}% used by paracol
\RequirePackage{xstring}% for case statements
\usepackage{paracol}% parallel columns
%----------------------------------------------------------------------------------------
%	HYPERLINKS IN THE DOCUMENTS
%----------------------------------------------------------------------------------------
\usepackage{hyperref}%
\hypersetup{%
  hidelinks
%  ,backref=true
%  ,pagebackref=true
%  ,hyperindex=true
  ,colorlinks=true
  ,citecolor=blue
  ,filecolor=blue
  ,linkcolor=blue
  ,urlcolor= ocre
  ,breaklinks=true
%  ,bookmarks=true
  ,bookmarksopen=false
  ,pdftitle={Title}
  ,pdfauthor={Author}
}
\usepackage{bookmark}%
\bookmarksetup{%
open,
numbered,
addtohook={%
\ifnum\bookmarkget{level}=0 % chapter
\bookmarksetup{bold}%
\fi%
\ifnum\bookmarkget{level}=-1 % part
\bookmarksetup{color=ocre,bold}%
\fi%
}%
}
%=============================================
% FONT SETUP
%=============================================
\usepackage{fontspec}%

\def\myFontDir{system/fonts}%
\usepackage{xcolor}%
\colorlet{RED}{red} % to handle color in headers
\definecolor{ocre}{RGB}{243,102,25} % Define the orange color used for highlighting throughout the book
\definecolor{auburn}{rgb}{0.43, 0.21, 0.1}%

\setmainfont[%
       Path = \myFontDir/Arimo/%
       , BoldFont = Arimo-Bold.ttf% 
       , ItalicFont = Arimo-Italic.ttf%
       , BoldItalicFont = Arimo-BoldItalic.ttf% 
       , Ligatures = TeX]{Arimo-Regular.ttf}%

\ifbool{supportKorean}{%
\usepackage{xeCJK} % for asian languages
\setCJKmainfont{fonts/korean/UnGungseo.ttf}%
\setCJKsansfont{fonts/korean/UnGungseo.ttf}%
\setCJKmonofont{fonts/korean/gulim.ttf}%
}{} 

\newcommand{\ltSetColor}[1]{%
\color{#1}%
}

%=============================================
% Paragraph Formats - NEEDED FOR MULTI COLUMN SUPPORT
%=============================================

\def\ltCenter{%
\Centering%
}%
\def\ltRightJustify{%
\RaggedLeft%
}%
\def\ltLeftJustify{%
\RaggedRight%
}%
\def\ltJustify{%
\justifying%
}%

%=============================================
% TYPEOGRAPHY - NEEDED FOR MULTI COLUMN SUPPORT
%=============================================
\pgfkeys{%
\my/current/typeography/.initial={\color{black}\textnormal}%
}

% call \ltTypeography after calling \ltSetTypeography
\newcommand{\ltSetTypeography}[1]{%
\pgfkeys{\my/current/typeography={#1}%
}%
%\ltTypeography{}%
}
\newcommand{\ltTypeography}{% 
\pgfkeysvalueof{\my/current/typeography}%
}
\newcommand{\ltTempTypeographyDefault}{%
\color{black}\ltTextBlack%
}
\newcommand{\ltSetTypeographyDefault}{%
	\pgfkeys{%
		\my/current/typeography={%
				\ltTextBlack%
		}%
}%
\ltTypeography{}%
}
\newcommand{\ltColor}[1]{%
\color{#1}%
}%
\def\ltTextBlack{\color{black}\mdseries\upshape}%
\def\ltTextBlackBold{\color{black}\bfseries}%
\def\ltTextBlackItalics{\color{black}\itshape}%
\def\ltTextBlackBoldItalics{\color{black}\bfseries\itshape}%
\def\ltTextRed{\color{red}\mdseries\upshape}%
\def\ltTextRedBold{\color{red}\bfseries}%
\def\ltTextRedItalics{\color{red}\itshape}%
\def\ltTextRedBoldItalics{\color{red}\bfseries\itshape}%
\def\ltCapsAndSmallCaps{\scshape}%
\def\ltTextUpright{\upshape}%
\def\ltParaIndent{\indent}%
\def\ltParaNoIndent{\noindent}%

% ============================================
% PARALLEL COLUMNS SETUP
%=============================================
\setlength{\columnsep}{30pt}%
\setlength\columnseprule{0.4pt}%

%============================================
% RIGHT TO LEFT SUPPORT - MUST BE LAST PACKAGE LOADED
%============================================
\usepackage{bidi}% 

%=========================================================
% Custom Commands
%=========================================================

\pgfkeys{%
    \my/resources/.cd%
    , path/.initial=resources%
}

\pgfkeys{%
    \my/current/.cd%
    , left/language/.initial=gr%
    , left/country/.initial=gr%
    , left/realm/.initial=cog%
    , left/text/.initial=
    , center/language/.initial=gr%
    , center/country/.initial=gr%
    , center/realm/.initial=cog%
    , center/text/.initial=
    , right/language/.initial=gr%
    , right/country/.initial=gr%
    , right/realm/.initial=cog%
    , right/text/.initial=
    , cols/.initial=1% 
}
\pgfkeys{%
    \my/domains/.cd%
    , left/.initial=/gr/gr/cog%
    , center/.initial=/gr/gr/cog%
    , right/.initial=/gr/gr/cog%
}
\pgfkeys{%
    \my/column/separator/.cd%
    , rule/color/.initial=gray%
    , rule/width/.initial=0.4%
    , width/.initial=30%
}

\newbool{haveLeftDomain}%
\boolfalse{haveLeftDomain}%
\newbool{haveCenterDomain}%
\boolfalse{haveCenterDomain}%
\newbool{haveRightDomain}%
\boolfalse{haveRightDomain}%

\newbool{blessed}
\boolfalse{blessed}

\newbool{subsectionInHeader}
\booltrue{subsectionInHeader}

\newbool{leftDomainIsRightToLeft}%
\boolfalse{leftDomainIsRightToLeft}%
\newbool{centerDomainIsRightToLeft}%
\boolfalse{centerDomainIsRightToLeft}%
\newbool{rightDomainIsRightToLeft}%
\boolfalse{rightDomainIsRightToLeft}%

%================================================
% RESOURCE LOADING
%================================================

\newcommand{\addResource}[4]{%
    \pgfkeyssetvalue{\myLoadedResources/#1/#2/#3/#4}{true}%
}%

% This only works if all resources for a given
% domain are in a single file.
\newcommand{\ltLoadResources}[1]{%
    \ifbool{haveLeftDomain}{%
        \ltLoadResource{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}
    }{%
    }%
    \ifbool{haveCenterDomain}{%
        \ltLoadResource{\pgfkeysvalueof{\my/current/center/language}}{\pgfkeysvalueof{\my/current/center/country}}{\pgfkeysvalueof{\my/current/center/realm}}{#1}
    }{%
    }%
    \ifbool{haveRightDomain}{%
        \ltLoadResource{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}
    }{%
    }%
}

\newcommand{\ltLoadResource}[4]{%
    \IfFileExists{%
        \pgfkeysvalueof{\my/resources/path}/#1_#2_#3/res.#4.tex%
    }{%
        \pgfkeysifdefined{\myLoadedResources/#1/#2/#3/#4}{%
        }{%
        % for some reason, \input adds a space
        \ignorespaces\input{\pgfkeysvalueof{\my/resources/path}/#1_#2_#3/res.#4.tex}\unskip%
        \addResource{#1}{#2}{#3}{#4}%
        }%
    }{% false
        missing \PackageError{ocmc-liturgical-text}{Missing \pgfkeysvalueof{\my/resources/path}/#1_#2_#3/res.#4.tex}%
        {%
        Add the missing file.%
        }%    
    }%
}
%================================================
% SPECIAL FONT LOADING
%================================================

\newcommand{\loadArabicFont}{%
\newfontfamily\arabicfont[%
Script=Arabic%
, Path = \myFontDir/Arabic/%
, BoldFont = amiri-bold.ttf%
, ItalicFont = amiri-slanted.ttf% 
, BoldItalicFont = amiri-boldslanted.ttf%
   ]{amiri-regular.ttf}%
}
\newcommand{\loadSlavonicFont}{%
\newfontfamily\slavonicfont[Path = \myFontDir/slavonic/ponomar/]{PonomarUnicode.ttf}%
}
\newcommand{\loadHebrewFont}{%
\newfontfamily\hebrewfont[%
    Script=Hebrew%
    , Path = \myFontDir/hebrew/%
    , BoldFont = ShofarDemi-Bold.ttf% 
    , ItalicFont = ShofarRegularOblique.ttf% 
    , BoldItalicFont = ShofarDemi-BoldOblique.ttf%
       ]{ShofarRegular.ttf}%                
}
\newcommand{\addFont}[1]{%
    \pgfkeyssetvalue{\myLoadedFonts/#1}{true}%
}

\newcommand{\loadFont}[1]{%
    \pgfkeysifdefined{\myLoadedFonts/#1}{%
        % ignore...nothing else to do
    }{% see if we should load a font for this language
        \IfStrEqCase{#1}{%
            {ara}{\loadArabicFont}%
            {chu}{\loadSlavonicFont}%
            {en}{}%
            {gr}{}%
            {heb}{\loadHebrewFont}%
            {rus}{}%
            {yid}{\loadHebrewFont}%
        }[]%
        \addFont{#1}%
    }%
}%

% checks the given language code to see
% if this is a RightToLeft language,
% and if so, sets the isRightToLeft
% boolean to true.
\newcommand{\ltSetDirectionForLeft}[1]{%
    \boolfalse{leftDomainIsRightToLeft}
    \IfStrEqCase{#1}{% change to true if is Right To Left
        {ara}{\booltrue{leftDomainIsRightToLeft}}%
        {heb}{\booltrue{leftDomainIsRightToLeft}}%
        {yid}{\booltrue{leftDomainIsRightToLeft}}%
    }[]%
}
\newcommand{\ltSetDirectionForCenter}[1]{%
    \boolfalse{centerDomainIsRightToLeft}
    \IfStrEqCase{#1}{% change to true if is Right To Left
        {ara}{\booltrue{centerDomainIsRightToLeft}}%
        {heb}{\booltrue{centerDomainIsRightToLeft}}%
        {yid}{\booltrue{centerDomainIsRightToLeft}}%
    }[]%
}
\newcommand{\ltSetDirectionForRight}[1]{%
    \boolfalse{rightDomainIsRightToLeft}
    \IfStrEqCase{#1}{% change to true if is Right To Left
        {ara}{\booltrue{rightDomainIsRightToLeft}}%
        {heb}{\booltrue{rightDomainIsRightToLeft}}%
        {yid}{\booltrue{rightDomainIsRightToLeft}}%
    }[]%
}
%================================================
% COMMANDS TO VERIFY A TITLE HAS KEYS FOR .doc .toc .header
%================================================
\newbool{hasDoc}%
\newbool{hasToc}%
\newbool{hasHeader}%
\newbool{titleHasAllParts}%


\newcommand{\ltCheckTitles}[5]{%
\boolfalse{hasDoc}%
\boolfalse{hasToc}%
\boolfalse{hasHeader}%
\boolfalse{titleHasAllParts}%
	\pgfkeysifdefined{/#1/#2/#3/#4/#5.doc}{%
		\booltrue{hasDoc}%
		\pgfkeysifdefined{/#1/#2/#3/#4/#5.toc}{%
				\booltrue{hasToc}%
				\pgfkeysifdefined{/#1/#2/#3/#4/#5.header}{%
					\booltrue{hasHeader}%
					\booltrue{titleHasAllParts}%
					}{% 
						% false is already set
				}%
			}{% 
			% false is already set
		}%
		}{% 
		% false is already set
	}%
}%

%================================================
% KEY-VALUE RETRIEVAL COMMANDS
%================================================


% sets things up for various languages.
% Note that if the language is not matched
% by the \IfStrEqCase, it treats it like English
\newcommand{\setup}[5]{%
    \pgfkeysifdefined{/#1/#2/#3/#4/#5}{%
            % ignore...good to go
    }{%
        \ltLoadResource{#1}{#2}{#3}{#4}%
    }%
    \loadFont{#1}%
    \itSetPrimaryDomain{#1}{#2}{#3}%
    \IfStrEqCase{#1}{%
        {ara}{\arabicfont\setRTL}%
        {chu}{\slavonicfont}%
        {en}{%
            \ifbool{hyphenate}{\selectlanguage{english}}{}%
        }%
        {gr}{%
            \ifbool{hyphenate}{\selectlanguage{greek}}{}%        
        }%
        {heb}{\hebrewfont\setRTL}%
        {rus}{}%
    }[\ifbool{hyphenate}{\selectlanguage{english}}{}]%
}

\newcommand{\ltCopyrightNotice}[1]{%
     \copyright\  \itSid{\pgfkeysvalueof{\my/current/#1/language}}{\pgfkeysvalueof{\my/current/#1/country}}{\pgfkeysvalueof{\my/current/#1/realm}}{copyright}{notice}%
}

\newcommand{\ltCopyRight}{%
\input{\ltSystemPath/copyright}%
}

\newcommand{\ltBlessing}{%
    \IfFileExists{\ltSystemPath/blessing}{%
        \input{\ltSystemPath/blessing}%
    }{% false
    }%
}

\newcommand{\ltPreface}{%
    \IfFileExists{\ltClientPath/preface}{%
        \input{\ltClientPath/preface}%
    }{% false
    }%
}

\newcommand{\ltCover}{%
    \ifbool{haveCenterDomain}{%
        \def\vspaceskip{0}%
    }{%
        \ifbool{haveRightDomain}{%
            \def\vspaceskip{2}%
        }{%
            \def\vspaceskip{6}%
        }%
    }%
    \begin{titlingpage}
    \openup .5em
    \begin{center}
    \vspace*{\vspaceskip\baselineskip}
    \begin{minipage}{25em}
    \begin{center}
    \linespread{2}
    \ltCoverTitle
    \end{center}
    \end{minipage}
    \vfill
    \includegraphics[width=.5\textwidth]{system/images/icxcnika.jpg}
    
    \ltSid{client.settings}{client.title}
    \end{center}
    \end{titlingpage}
}
\newcommand{\ltCoverTitle}{
\huge\ltSid{client.settings}{cover.title}\normalsize%
\ltCoverLanguages{}%
%\ltCoverSubTitles{}%
}
\newcommand{\ltCoverLanguages}{%
    \begin{center}
    \ifbool{haveCenterDomain}{%
        \itSid{sys}{iso}{language.code}{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/language}} |         \itSid{sys}{iso}{language.code}{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/center/language}} | \itSid{sys}{iso}{language.code}{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/right/language}}
    }{%
        \ifbool{haveRightDomain}{%
        \itSid{sys}{iso}{language.code}{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/language}} | \itSid{sys}{iso}{language.code}{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/right/language}}
        }{%
        }%
    }%
    \end{center}
}

\newcommand{\ltCoverSubTitles}{%
    \begin{center}
    \ifbool{haveCenterDomain}{%
            \itSid{\pgfkeysvalueof{\my/current/center/language}}{\pgfkeysvalueof{\my/current/center/country}}{\pgfkeysvalueof{\my/current/center/realm}}{client.settings}{cover.title}\newline%
            \itSid{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{client.settings}{cover.title}%
    }{%
        \ifbool{haveRightDomain}{%
            \itSid{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{client.settings}{cover.title}%
        }{%
        }%
    }%
    \end{center}
}


\newcommand{\ltChapter}[2]{
    \ltGetChapter{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
    \ltChapterSubTitles{#1}{#2}
}

\newcommand{\ltChapterSubTitles}[2]{%
\begin{center}
    {\IfStrEqCase{\pgfkeysvalueof{\my/current/cols}}{%
        {1}{%  output one column
        }%
        {2}{% output two columns
            \ltGetSection{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}{#2}%
        }%
        {3}{% output three columns
            \ltGetSection{\pgfkeysvalueof{\my/current/center/language}}{\pgfkeysvalueof{\my/current/center/country}}{\pgfkeysvalueof{\my/current/center/realm}}{#1}{#2}%
            \ltGetSection{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}{#2}%
        }%
    }[]%
    }%
\end{center}
}

\newcommand{\ltGetChapter}[5]{%
\setup{#1}{#2}{#3}{#4}{#5.doc}%
\ltCheckTitles{#1}{#2}{#3}{#4}{#5}%
\ifbool{titleHasAllParts}{%
\chapter[\itSid{#1}{#2}{#3}{#4}{#5.toc}]{\centering\itSid{#1}{#2}{#3}{#4}{#5.doc}}%
\chaptermark{\itSid{#1}{#2}{#3}{#4}{#5.header}}%
\setLTR%
}{%
\throwTitleError{#1}{#2}{#3}{#4}{#5}%
}%
}

\newcommand{\ltSection}[2]{
    {\IfStrEqCase{\pgfkeysvalueof{\my/current/cols}}{%
        {1}{%  output one column
        \ltGetSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                }%
        {2}{% output two columns
            \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
            \mysloppy%
            \begin{paracol}{2}%
            	\begin{leftcolumn}%
                \ltGetSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                \end{leftcolumn}%          
            	\begin{rightcolumn}%
                    \ltGetSection{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}{#2}%
                \end{rightcolumn}%          
            \end{paracol}%
        }%
        {3}{% output three columns
            \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
            \mysloppy%
            \begin{paracol}{3}%
                    \ltGetSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                \switchcolumn%
                    \ltGetSection{\pgfkeysvalueof{\my/current/center/language}}{\pgfkeysvalueof{\my/current/center/country}}{\pgfkeysvalueof{\my/current/center/realm}}{#1}{#2}%
                \switchcolumn%
                    \ltGetSection{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}{#2}%
                \end{paracol}%
        }%
    }[]%
    }%
}

\newcommand{\ltGetSection}[5]{%
\setup{#1}{#2}{#3}{#4}{#5.doc}%
\ltCheckTitles{#1}{#2}{#3}{#4}{#5}%
\ifbool{titleHasAllParts}{%
\section[\itSid{#1}{#2}{#3}{#4}{#5.toc}]{\centering\itSid{#1}{#2}{#3}{#4}{#5.doc}}%
\sectionmark{\itSid{#1}{#2}{#3}{#4}{#5.header}}%
\setLTR%
}{%
\throwTitleError{#1}{#2}{#3}{#4}{#5}%
}%
}

\newcommand{\ltSubSection}[2]{
    {\IfStrEqCase{\pgfkeysvalueof{\my/current/cols}}{%
        {1}{%  output one column
        \ltGetSubSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                }%
        {2}{% output two columns
            \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
            \mysloppy%
            \begin{paracol}{2}%
            	\begin{leftcolumn}%
                    \ltGetSubSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                \end{leftcolumn}%          
            	\begin{rightcolumn}%
                    \ltGetSubSection{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}{#2}%
                \end{rightcolumn}%          
            \end{paracol}%
        }%
        {3}{% output three columns
            \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
            \mysloppy%
            \begin{paracol}{3}%
                    \ltGetSubSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                \switchcolumn%
                    \ltGetSubSection{\pgfkeysvalueof{\my/current/center/language}}{\pgfkeysvalueof{\my/current/center/country}}{\pgfkeysvalueof{\my/current/center/realm}}{#1}{#2}%
                \switchcolumn%
                    \ltGetSubSection{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}{#2}%
                \end{paracol}%
        }%
    }[]%
    }%
}

\newcommand{\ltGetSubSection}[5]{%
\setup{#1}{#2}{#3}{#4}{#5.doc}%
\ltCheckTitles{#1}{#2}{#3}{#4}{#5}%
\ifbool{titleHasAllParts}{%
\subsection[\itSid{#1}{#2}{#3}{#4}{#5.toc}]{\itSid{#1}{#2}{#3}{#4}{#5.doc}}%
\ifbool{subsectionInHeader}{%
\sectionmark{\itSid{#1}{#2}{#3}{#4}{#5.header}}%
}{%
\subsectionmark{\itSid{#1}{#2}{#3}{#4}{#5.header}}%
}%
\setLTR%
}{%
\throwTitleError{#1}{#2}{#3}{#4}{#5}%
}%
}

\newcommand{\ltSubSubSection}[2]{
    {\IfStrEqCase{\pgfkeysvalueof{\my/current/cols}}{%
        {1}{%  output one column
        \ltGetSubSubSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                }%
        {2}{% output two columns
            \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
            \mysloppy%
            \begin{paracol}{2}%
            	\begin{leftcolumn}%
                    \ltGetSubSubSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                \end{leftcolumn}%          
            	\begin{rightcolumn}%
                    \ltGetSubSubSection{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}{#2}%
                \end{rightcolumn}%          
            \end{paracol}%
        }%
        {3}{% output three columns
            \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
            \mysloppy%
            \begin{paracol}{3}%
                    \ltGetSubSubSection{\pgfkeysvalueof{\my/current/left/language}}{\pgfkeysvalueof{\my/current/left/country}}{\pgfkeysvalueof{\my/current/left/realm}}{#1}{#2}%
                \switchcolumn%
                    \ltGetSubSubSection{\pgfkeysvalueof{\my/current/center/language}}{\pgfkeysvalueof{\my/current/center/country}}{\pgfkeysvalueof{\my/current/center/realm}}{#1}{#2}%
                \switchcolumn%
                    \ltGetSubSubSection{\pgfkeysvalueof{\my/current/right/language}}{\pgfkeysvalueof{\my/current/right/country}}{\pgfkeysvalueof{\my/current/right/realm}}{#1}{#2}%
                \end{paracol}%
        }%
    }[]%
    }%
}

\newcommand{\ltGetSubSubSection}[5]{%
\setup{#1}{#2}{#3}{#4}{#5.doc}%
\ltCheckTitles{#1}{#2}{#3}{#4}{#5}%
\ifbool{titleHasAllParts}{%
\subsubsection[\itSid{#1}{#2}{#3}{#4}{#5.toc}]{\itSid{#1}{#2}{#3}{#4}{#5.doc}}%
\subsubsectionmark{\itSid{#1}{#2}{#3}{#4}{#5.header}}%
\setLTR%
}{%
\throwTitleError{#1}{#2}{#3}{#4}{#5}%
}%
}

\newcommand{\ltGetTitle}[6]{
\setup{#1}{#2}{#3}{#4}{#5.doc}%
\pgfkeysifdefined{/#1/#2/#3/#4/#5.doc}{%
\expandafter{\csname #6\endcsname}[\itSid{#1}{#2}{#3}{#4}{#5.toc}]{\itSid{#1}{#2}{#3}{#4}{#5.doc}}%
\expandafter{\csname #6mark\endcsname}{\itSid{#1}{#2}{#3}{#4}{#5.header}}%
\setLTR%
}{%
\throwTitleError{#1}{#2}{#3}{#4}{#5}%
}%
}

\newcommand{\throwTitleError}[5]{%
	\pgfkeysifdefined{/#1/#2/#3/#4/#5.doc}{
			% do nothing
		}{ % else throw doc error
	        \PackageError{%
    			    ocmc-liturgical-text}{Missing .doc for ‘/#1/#2/#3/#4/#5’.%
        		}{%
        			Open resource file for /#1/#2/#3/#4 and add .doc key for #5.%
        		}%
	}
	\pgfkeysifdefined{/#1/#2/#3/#4/#5.toc}{
			% do nothing
		}{ % else throw toc error
	        \PackageError{%
    			    ocmc-liturgical-text}{Missing .toc for ‘/#1/#2/#3/#4/#5’.%
        		}{%
        			Open resource file for /#1/#2/#3/#4 and add .toc key for #5.%
        		}%
	}
	\pgfkeysifdefined{/#1/#2/#3/#4/#5.header}{
			% do nothing
		}{ % else throw header error
	        \PackageError{%
    			    ocmc-liturgical-text}{Missing .header for ‘/#1/#2/#3/#4/#5’.%
        		}{%
        			Open resource file for /#1/#2/#3/#4 and add .header key for #5.%
        		}%
	}
}

\newcommand{\ltGetVal}[5]{%
\setup{#1}{#2}{#3}{#4}{#5}%
\itSid{#1}{#2}{#3}{#4}{#5}%
\setLTR%
}

\newcommand\ltSid[2]{%
    {\IfStrEqCase{\pgfkeysvalueof{\my/current/cols}}{%
    {1}{%  output one column
			\ltTypeography{}%
            \ltGetColVal{left}{#1}{#2}%
             \ltTempTypeographyDefault%
        }%
    {2}{% output two columns
        \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
        \mysloppy%
        \begin{paracol}{2}%
        	\begin{leftcolumn}%
			\ltTypeography{}%
            \ltGetColVal{left}{#1}{#2}%
            \ltTempTypeographyDefault%
            \end{leftcolumn}%          
        	\begin{rightcolumn}%
			\ltTypeography{}%
            \ltGetColVal{right}{#1}{#2}%         
            \ltTempTypeographyDefault%
            \end{rightcolumn}%          
        \end{paracol}%
    }%
    {3}{% output three columns
        \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
        \mysloppy%
        \begin{paracol}{3}%
        	\begin{nthcolumn}{0}%
			\ltTypeography{}%
            \ltGetColVal{left}{#1}{#2}%
            \ltTempTypeographyDefault%
            \end{nthcolumn}%          
        	\begin{nthcolumn}{1}%
			\ltTypeography{}%
            \ltGetColVal{center}{#1}{#2}%          
            \ltTempTypeographyDefault%
            \end{nthcolumn}%          
        	\begin{nthcolumn}{2}%
			\ltTypeography{}%
            \ltGetColVal{right}{#1}{#2}%         
            \ltTempTypeographyDefault%
            \end{nthcolumn}%          
        \end{paracol}%
    }%
}[]%
}%
}

%================================================
% LITURGICAL FORMATTING COMMANDS
%================================================
\newcommand\ltAsterisksLine{{\small\color{red}\leavevmode\xleaders\hbox{$\ast$}\hfill\kern0pt\normalsize\color{black}\smallbreak}}

% this doesn't quite work yet with multilingual
\newcommand\ltCommentBox[1]{
%    \medskip%
    \noindent\fcolorbox{red}{white}{%
    \minipage[t]{\dimexpr0.98\linewidth\fboxsep\fboxrule\relax}
    #1%
    \endminipage}\hfill%
%    \medskip%
}

\newcommand\ltActor[1]{%
    \ltTextRed#1\ltTextBlack%
}

\newcommand\ltBlack[1]{%
\ltSetTypeography{%
\ltColor{black}%
}%
#1%
}%

\DeclareDocumentCommand\ltDesignation{ m m g g g g g g}{%
    \ltSidsFormat{\ltTextRedItalics}{\ltTextRedItalics}{\ltTextRedItalics}{\ltTextRedItalics}%
    \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}

\DeclareDocumentCommand\ltDialog{m m g g g g g g}{%
    \ltSidsFormat{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}%
    \IfValueTF{#7}{%
        \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
    }{%
        \IfValueTF{#5}{%
            \ltSids{#1}{#2}{#3}{#4}{#5}{#6}%
        }{%
            \IfValueTF{#3}{%
                \ltSids{#1}{#2}{#3}{#4}%
            }{%
                \ltSetTypeographyDefault{}%
                \ltSid{#1}{#2}%
            }%
        }%
    }%
}%

% Call this if you do not want dialog to set its 
% own format
\DeclareDocumentCommand\ltDialogNoFormat{m m g g g g g g}{%
    \IfValueTF{#7}{%
        \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
    }{%
        \IfValueTF{#5}{%
            \ltSids{#1}{#2}{#3}{#4}{#5}{#6}%
        }{%
            \IfValueTF{#3}{%
                \ltSids{#1}{#2}{#3}{#4}%
            }{%
                \ltSetTypeographyDefault{}%
                \ltSid{#1}{#2}%
            }%
        }%
    }%
}%

\DeclareDocumentCommand\ltHymn{ m m g g g g g g}{%
    \ltSidsFormat{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}%
    \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}

\DeclareDocumentCommand\ltHymnNoFormat{ m m g g g g g g}{%
\ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}

\DeclareDocumentCommand\ltHymnLastLine{ m m g g g g g g}{%
    \ltSidsFormat{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}%
    \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}

\newcommand\ltInaudible[1]{\ltSetTypeographyDefault{}#1}%
\newcommand\ltTitle[1]{\ltSetTypeographyDefault{}#1}
\newcommand\ltMelody[1]{\ltSetTypeographyDefault{}#1}
\newcommand\ltMixed[1]{\ltSetTypeographyDefault{}#1}
\newcommand\ltMode[1]{\ltSetTypeographyDefault{}#1}

\DeclareDocumentCommand\ltReading{ m m g g g g g g}{%
    \ltSidsFormat{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}%
    \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}

\newcommand\ltRed[1]{%
\ltSetTypeography{%
\ltColor{red}%
}%
#1%
}%

\DeclareDocumentCommand\ltVerse{ m m g g g g g g}{%
    \ltSidsFormat{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}%
    \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}

% Sets number of columns based on
% whether or not user has declared
% a domain for each column
\newcommand{\ltColumnsOn}{%
    \ifbool{haveCenterDomain}{%
        \ltSetNumberColumns{3}%
    }{%
        \ifbool{haveRightDomain}{%
            \ltSetNumberColumns{2}%
        }{%
            \ltSetNumberColumns{1}%
        }%
    }%
}

\newcommand{\ltColumnsOff}{\ltSetNumberColumns{1}}%

% Valid values are 1, 2, or 3.
% This controls the number of columns
% to be displayed.
\newcommand{\ltSetNumberColumns}[1]{%
    \pgfkeys{%
        \my/current/cols = #1%
    }%
}
\newcommand{\ltSetPrimaryDomain}[3]{%
\pgfkeys{\my/domains/left = /#1/#2/#3}%
\pgfkeys{\my/current/left/.cd%
 , language = #1%
 , country = #2%
 , realm = #3%
 }%
 \booltrue{haveLeftDomain}%
 \itSetPrimaryDomain{#1}{#2}{#3}%
\ltSetDirectionForLeft{#1}%
}
\newcommand{\ltSetCenterDomain}[3]{%
\pgfkeys{\my/domains/center = /#1/#2/#3}%
\pgfkeys{\my/current/center/.cd%
 , language = #1%
 , country = #2%
 , realm = #3%
 }%
 \booltrue{haveCenterDomain}%
\ltSetDirectionForCenter{#1}%
}
\newcommand{\ltSetRightDomain}[3]{%
\pgfkeys{\my/domains/right = /#1/#2/#3}%
\pgfkeys{\my/current/right/.cd%
 , language = #1%
 , country = #2%
 , realm = #3%
 }%
 \booltrue{haveRightDomain}%
\ltSetDirectionForRight{#1}%
}

\newcommand\ltColumnSeparatorColor[1]{\pgfkeys{\my/column/separator/rule/color = #1}}

\newcommand\ltGetColVal[3]{%
    \ltGetVal{\ltGetLanguage{#1}}{\ltGetCountry{#1}}{\ltGetRealm{#1}}{#2}{#3}%
}%

\newcommand{\ltGetLanguage}[1]{%
\pgfkeysvalueof{\my/current/#1/language}%
}%

\newcommand{\ltGetCountry}[1]{%
\pgfkeysvalueof{\my/current/#1/country}%
}%

\newcommand{\ltGetRealm}[1]{%
\pgfkeysvalueof{\my/current/#1/realm}%
}

\newcommand{\ltLoadResourceForSid}[1]{%
\ltLoadResource{\langPrimary}{\countryPrimary}{\realmPrimary}{#1}%
\ltLoadResource{\langSecondary}{\countrySecondary}{\realmSecondary}{#1}%
}
%=========================================================
% Global Settings. Overriden if control.tex used
%=========================================================
\setlength{\parindent}{0em} % turns off indenting of paragraphs.  Comment out to turn on.
\setlength{\parskip}{1em}  % spacing between paragraphs 0.5 is usual
\setlength{\JustifyingParindent}{0em} % turns off indenting of paragraphs.  Comment out to turn on.
\setlength{\JustifyingParfillskip}{0.5em}  % spacing between paragraphs 0.5 is usual
\setsecnumdepth{none} % none turns off numbering
\maxsecnumdepth{none}
\titleformat{\section}[block]{\color{blue}\Large\bfseries\filcenter}{}{1em}{}
\pagestyle{ruled}
\makeevenhead{ruled}{}{\rightmark}{\thepage}
\makeoddhead{ruled}{\thepage}{\leftmark}{}
\makeevenfoot{ruled}{}{}{}
\makeoddfoot{ruled}{}{}{}
\setbool{subsectionInHeader}{true}% false to turn off 
{\addtolength{\beforechapskip}{-3\baselineskip}
{\addtolength{\afterchapskip}{-3\baselineskip}


% to help with avoiding overfull 
% hbox with narrow columns.
% Note that the max is 10000 for h or vbadness.
% If you set to 10000 completely ignores.
% 9999 is tolerant of anything up to 10000
\def\mysloppy{%
  \tolerance=9999
  \setlength{\emergencystretch}{0.5em}
  \hfuzz 1pt
  \vfuzz=\hfuzz
  \hbadness=9999
  \vbadness=\maxdimen
}

%================================================
% MULTI SID -- NEEDED FOR MULTILINGUAL TEXT
%================================================
\def\theLeft{}
\def\theCenter{}
\def\theRight{}

\def\sidOneFormat{}
\def\sidTwoFormat{}
\def\sidThreeFormat{}
\def\sidFourFormat{}

\newcommand{\ltAppendersReset}{%
    \global\def\theLeft{}% set to be empty
    \global\def\theCenter{}% set to be empty
    \global\def\theRight{}% set to be empty
}
\DeclareDocumentCommand\ltSids{m m m m g g g g } {%
    \ltAppendersReset%
    \ltSidsAppendersLeft{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
    {\IfStrEqCase{\pgfkeysvalueof{\my/current/cols}}{%
        {1}{%  output one column
            }%
        {2}{% output two columns
            \ltSidsAppendersRight{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
            }%
        {3}{% output three columns
            \ltSidsAppendersCenter{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
            \ltSidsAppendersRight{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
            }%
    }[]%
    }%    
    \ltFormatThree{\theLeft}{\theCenter}{\theRight}%
}

% Globally defines the text for a Left Column line by concatenating the parms
\DeclareDocumentCommand\ltSidsAppendersLeft{m m m m g g g g } {%
    \global\def\theLeft{}% first set to be empty
    \ifbool{leftDomainIsRightToLeft}{%
        \IfValueTF{#7}{%
            \global\def\theLeft{%
                \setRTL%
                \sidOneFormat\ltGetColVal{left}{#1}{#2} \sidOneFormat \sidTwoFormat\ltGetColVal{left}{#3}{#4} \sidTwoFormat \sidThreeFormat\ltGetColVal{left}{#5}{#6} \sidThreeFormat \ltGetColVal{left}{#7}{#8}\sidFourFormat%
            }%
        }{%
            \IfValueTF{#5}{%
                \global\def\theLeft{%
                    \setRTL%
                    \sidOneFormat\ltGetColVal{left}{#1}{#2} \sidOneFormat \sidTwoFormat\ltGetColVal{left}{#3}{#4} \sidTwoFormat \ltGetColVal{left}{#5}{#6}\sidThreeFormat%
                }%
            }{%
                \IfValueTF{#3}{%
                \global\def\theLeft{%
                    \setRTL%
                        \sidTwoFormat\ltGetColVal{left}{#1}{#2} \sidOneFormat \ltGetColVal{left}{#3}{#4}%
                }%
                }{%
                    \global\def\theLeft{\setRTL\sidOneFormat\ltGetColVal{left}{#1}{#2}}%
                }%
            }%
        }%
    }{%
        \IfValueTF{#7}{%
            \global\def\theLeft{\sidOneFormat\ltGetColVal{left}{#1}{#2} \sidTwoFormat\ltGetColVal{left}{#3}{#4} \sidThreeFormat\ltGetColVal{left}{#5}{#6} \sidFourFormat\ltGetColVal{left}{#7}{#8}}%
        }{%
            \IfValueTF{#5}{%
                \global\def\theLeft{\sidOneFormat\ltGetColVal{left}{#1}{#2} \sidTwoFormat\ltGetColVal{left}{#3}{#4} \sidThreeFormat\ltGetColVal{left}{#5}{#6}}%
            }{%
                \IfValueTF{#3}{%
                    \global\def\theLeft{\sidOneFormat\ltGetColVal{left}{#1}{#2} \sidTwoFormat\ltGetColVal{left}{#3}{#4}}%
                }{%
                    \global\def\theLeft{\sidOneFormat\ltGetColVal{left}{#1}{#2}}%
                }%
            }%
        }%
    }
}

% Globally defines the text for a Center Column line by concatenating the parms
\DeclareDocumentCommand\ltSidsAppendersCenter{m m m m g g g g } {%
    \global\def\theCenter{}% first set to be empty
    \ifbool{centerDomainIsRightToLeft}{%
        \IfValueTF{#7}{%
            \global\def\theCenter{%
                \setRTL%
                \sidOneFormat\ltGetColVal{center}{#1}{#2} \sidOneFormat \sidTwoFormat\ltGetColVal{center}{#3}{#4} \sidTwoFormat \sidThreeFormat\ltGetColVal{center}{#5}{#6} \sidThreeFormat \ltGetColVal{center}{#7}{#8}\sidFourFormat%
            }%
        }{%
            \IfValueTF{#5}{%
                \global\def\theCenter{%
                    \setRTL%
                    \sidOneFormat\ltGetColVal{center}{#1}{#2} \sidOneFormat \sidTwoFormat\ltGetColVal{center}{#3}{#4} \sidTwoFormat \ltGetColVal{center}{#5}{#6}\sidThreeFormat%
                }%
            }{%
                \IfValueTF{#3}{%
                \global\def\theCenter{%
                    \setRTL%
                        \sidTwoFormat\ltGetColVal{center}{#1}{#2} \sidOneFormat \ltGetColVal{center}{#3}{#4}%
                }%
                }{%
                    \global\def\theCenter{\setRTL\sidOneFormat\ltGetColVal{center}{#1}{#2}}%
                }%
            }%
        }%
    }{%
        \IfValueTF{#7}{%
            \global\def\theCenter{\sidOneFormat\ltGetColVal{center}{#1}{#2} \sidTwoFormat\ltGetColVal{center}{#3}{#4} \sidThreeFormat\ltGetColVal{center}{#5}{#6} \sidFourFormat\ltGetColVal{center}{#7}{#8}}%
        }{%
            \IfValueTF{#5}{%
                \global\def\theCenter{\sidOneFormat\ltGetColVal{center}{#1}{#2} \sidTwoFormat\ltGetColVal{center}{#3}{#4} \sidThreeFormat\ltGetColVal{center}{#5}{#6}}%
            }{%
                \IfValueTF{#3}{%
                    \global\def\theCenter{\sidOneFormat\ltGetColVal{center}{#1}{#2} \sidTwoFormat\ltGetColVal{center}{#3}{#4}}%
                }{%
                    \global\def\theCenter{\sidOneFormat\ltGetColVal{center}{#1}{#2}}%
                }%
            }%
        }%
    }
}

% Globally defines the text for a Right Column line by concatenating the parms
\DeclareDocumentCommand\ltSidsAppendersRight{m m m m g g g g } {%
    \global\def\theRight{}% first set to be empty
    \ifbool{rightDomainIsRightToLeft}{%
        \IfValueTF{#7}{%
            \global\def\theRight{%
                \setRTL%
                \sidOneFormat\ltGetColVal{right}{#1}{#2} \sidOneFormat \sidTwoFormat\ltGetColVal{right}{#3}{#4} \sidTwoFormat \sidThreeFormat\ltGetColVal{right}{#5}{#6} \sidThreeFormat \ltGetColVal{right}{#7}{#8}\sidFourFormat%
            }%
        }{%
            \IfValueTF{#5}{%
                \global\def\theRight{%
                    \setRTL%
                    \sidOneFormat\ltGetColVal{right}{#1}{#2} \sidOneFormat \sidTwoFormat\ltGetColVal{right}{#3}{#4} \sidTwoFormat \ltGetColVal{right}{#5}{#6}\sidThreeFormat%
                }%
            }{%
                \IfValueTF{#3}{%
                \global\def\theRight{%
                    \setRTL%
                        \sidTwoFormat\ltGetColVal{right}{#1}{#2} \sidOneFormat \ltGetColVal{right}{#3}{#4}%
                }%
                }{%
                    \global\def\theRight{\setRTL\sidOneFormat\ltGetColVal{right}{#1}{#2}}%
                }%
            }%
        }%
    }{%
        \IfValueTF{#7}{%
            \global\def\theRight{\sidOneFormat\ltGetColVal{right}{#1}{#2} \sidTwoFormat\ltGetColVal{right}{#3}{#4} \sidThreeFormat\ltGetColVal{right}{#5}{#6} \sidFourFormat\ltGetColVal{right}{#7}{#8}}%
        }{%
            \IfValueTF{#5}{%
                \global\def\theRight{\sidOneFormat\ltGetColVal{right}{#1}{#2} \sidTwoFormat\ltGetColVal{right}{#3}{#4} \sidThreeFormat\ltGetColVal{right}{#5}{#6}}%
            }{%
                \IfValueTF{#3}{%
                    \global\def\theRight{\sidOneFormat\ltGetColVal{right}{#1}{#2} \sidTwoFormat\ltGetColVal{right}{#3}{#4}}%
                }{%
                    \global\def\theRight{\sidOneFormat\ltGetColVal{right}{#1}{#2}}%
                }%
            }%
        }%
    }
}

% sets the multiple sid format to be empty
\newcommand{\ltSidsFormatReset}{%
    \global\def\sidOneFormat{}%
    \global\def\sidTwoFormat{}%
    \global\def\sidThreeFormat{}%
    \global\def\sidFourFormat{}%
}

% Sets the format for up to four sids
% Must be called prior to \ltSids if want special format
\DeclareDocumentCommand\ltSidsFormat{m g g g } {%
    \ltSidsFormatReset%
    {\global\def\sidOneFormat{#1}%
        \IfNoValueF {#2} {\global\def\sidTwoFormat{#2}}%
        \IfNoValueF {#3} {\global\def\sidThreeFormat{#3}}%
        \IfNoValueF {#4} {\global\def\sidFourFormat{#4}}%
    }%
}

\DeclareDocumentCommand\ltActorDialog{m m m m g g g g}{%
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}%
        \ifdef{\actorOnSeparateLine}{%
        \ltActor{\ltSid{#1}{#2}}%
        
        \ltDialogNoFormat{#3}{#4}{#5}{#6}{#7}{#8}%
    }{%
        \ltSids{#1}{#2.colon}{#3}{#4}{#5}{#6}{#7}{#8}%
    }%
}

\DeclareDocumentCommand\ltActorDialogLowVoice{ m m m m g g }{%
    \ifdef{\actorOnSeparateLine}{%
        \ltActor{\ltSid{#1}{#2}}%
        
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextBlack}%
        \ltDialogNoFormat{actors}{InALowVoice}{#3}{#4}{#5}{#6}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}{\ltTextBlack}%
        \ltSids{#1}{#2}{actors}{InALowVoice.colon}{#3}{#4}{#5}{#6}%
    }%
}
\DeclareDocumentCommand\ltRubric{ m m g g g g g g}{%
    \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextRed}{\ltTextRed}%
    \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}

\DeclareDocumentCommand\ltRubricDialogLowVoice{ m m m m g g }{%
    \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}%
    \ltSids{#1}{#2}{actors}{InALowVoice.colon}{#3}{#4}{#5}{#6}%
}
\DeclareDocumentCommand\ltRubricDialogAloud{ m m m m g g }{%
    \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}%
    \ltSids{#1}{#2}{actors}{Aloud.colon}{#3}{#4}{#5}{#6}%
}
\DeclareDocumentCommand\ltActorDialogAloud{ m m m m g g }{%
    \ifdef{\actorOnSeparateLine}{%
        \ltActor{\ltSid{#1}{#2}}%
        
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}%
        \ltDialogNoFormat{actors}{Aloud}{#3}{#4}{#5}{#6}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}%
        \ltSids{#1}{#2}{actors}{Aloud.colon}{#3}{#4}{#5}{#6}%
    }%
}
% Only supports one topic-key for the Dialog
\DeclareDocumentCommand\ltActorDialogLowVoiceRubric{ m m m m m m }{%
    \ifdef{\actorOnSeparateLine}{%
        \ltActor{\ltSid{#1}{#2}}%
        
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextRed}%
        \ltDialogNoFormat{actors}{InALowVoice}{#3}{#4}{#5}{#6}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}{\ltTextRed}%
        \ltSids{#1}{#2}{actors}{InALowVoice.colon}{#3}{#4}{#5}{#6}%
    }%
}

\newcommand{\ltActorRubricDialog}[6]{%
    \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}%
    \ifdef{\actorOnSeparateLine}{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}%
        \ltSids{#1}{#2}{#3}{#4}%
        
        \ltDialogNoFormat{#5}{#6}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}%
        \ltSids{#1}{#2.colon}{#3}{#4}{#5}{#6}%
    }%
}

\newcommand{\ltRubricDialog}[4]{%
    \ltSidsFormat{\ltTextRed}{\ltTextBlack}%
    \ltSids{#1}{#2}{#3}{#4}%
}

\newcommand{\ltRubricDialogRubric}[6]{%
    \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextRed}%
    \ltSids{#1}{#2}{#3}{#4}{#5}{#6}%
}

\newcommand{\ltRubricDialogRubricDialog}[8]{%
    \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextRed}{\ltTextBlack}%
    \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}

\newcommand{\ltDialogAloud}[2]{%
    \ltSidsFormat{\ltTextRed}{\ltTextBlack}%
    \ltSids{actors}{Aloud}{#1}{#2}%
}

\newcommand{\ltDialogLowVoice}[2]{%
    \ltSidsFormat{\ltTextRed}{\ltTextBlack}%
    \ltSids{actors}{InALowVoice}{#1}{#2}%
}

\newcommand{\ltActorDialogRubric}[6]{%
    \ifdef{\actorOnSeparateLine}{%
        \ltActor{\ltSid{#1}{#2}}%
        
        \ltSidsFormat{\ltTextBlack}{\ltTextRed}%
        \ltDialogNoFormat{#3}{#4}{#5}{#6}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextRed}%
        \ltSids{#1}{#2.colon}{#3}{#4}{#5}{#6}%
    }%
}
\newcommand{\ltActorRubricDialogRubric}[8]{%
    \ifdef{\actorOnSeparateLine}{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}%
        \ltSids{#1}{#2}{#3}{#4}%
        
        \ltSidsFormat{\ltTextBlack}{\ltTextRed}%
        \ltDialogNoFormat{#5}{#6}{#7}{#8}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}{\ltTextRed}%
        \ltSids{#1}{#2.colon}{#3}{#4}{#5}{#6}{#7}{#8}%
    }%
}

\newcommand{\ltActorDialogRubricDialog}[8]{%
    \ifdef{\actorOnSeparateLine}{%
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}%
        \ltSids{#1}{#2}{#3}{#4}%
        
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}%
        \ltDialogNoFormat{#5}{#6}{#7}{#8}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextRed}{\ltTextBlack}%
        \ltSids{#1}{#2.colon}{#3}{#4}{#5}{#6}{#7}{#8}%
    }%
}

\newcommand{\ltActorHymn}[4]{%
    \ltSidsFormat{\ltTextRed}{\ltTextBlack}
    \ifdef{\actorOnSeparateLine}{%
        \ltActor{\ltSid{#1}{#2}}%
        
        \ltHymnNoFormat{#3}{#4}%
    }{%
        \ltHymnNoFormat{#1}{#2.colon}{#3}{#4}%
    }%
}

\newcommand{\ltActorReading}[4]{%
    \ltSidsFormat{\ltTextRed}{\ltTextBlack}
    \ifdef{\actorOnSeparateLine}{%
        \ltActor{\ltSid{#1}{#2}}%
        
        \ltReading{#3}{#4}%
    }{%
        \ltReading{#1}{#2.colon}{#3}{#4}%
    }%
}

\newcommand{\ltActorRubricHymn}[6]{%
    \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}%
    \ifdef{\actorOnSeparateLine}{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}%
        \ltSids{#1}{#2}{#3}{#4}%
        
        \ltDialogNoFormat{#5}{#6}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}
        \ltSids{#1}{#2}{#3}{#4}{#5}{#6}%
    }%
}
\newcommand{\ltActorHymnRubric}[6]{%
    \ifdef{\actorOnSeparateLine}{%
        \ltActor{\ltSid{#1}{#2}}%
        
        \ltSidsFormat{\ltTextBlack}{\ltTextRed}%
        \ltHymnNoFormat{#3}{#4}{#5}{#6}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextRed}%
        \ltSids{#1}{#2.colon}{#3}{#4}{#5}{#6}%
    }%
}

\newcommand{\ltActorRubricHymnRubric}[8]{%
    \ifdef{\actorOnSeparateLine}{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}%
        \ltSids{#1}{#2}{#3}{#4}%
        
        \ltSidsFormat{\ltTextBlack}{\ltTextRed}%
        \ltHymnNoFormat{#5}{#6}{#7}{#8}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}{\ltTextBlack}{\ltTextRed}%
        \ltSids{#1}{#2.colon}{#3}{#4}{#5}{#6}{#7}{#8}%
    }%
}

\newcommand{\ltActorHymnHymnRubric}[8]{%
    \ifdef{\actorOnSeparateLine}{%
        \ltSidsFormat{\ltTextRed}{\ltTextRed}%
        \ltSids{#1}{#2}{#3}{#4}%
        
        \ltSidsFormat{\ltTextBlack}{\ltTextBlack}{\ltTextRed}%
        \ltHymnNoFormat{#5}{#6}{#7}{#8}%
    }{%
        \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextBlack}{\ltTextRed}%
        \ltSids{#1}{#2.colon}{#3}{#4}{#5}{#6}{#7}{#8}%
    }%
}

\DeclareDocumentCommand\ltHymnRubric{m m m m g g g g} {%
    \ltSidsFormatReset%
    {\global\def\sidOneFormat{#1}%
        \IfValueTF {#7}{%
            \ltSidsFormat{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}{\ltTextRed}%
            \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
        }{%
            \IfValueTF {#5}{%
            \ltSidsFormat{\ltTextBlack}{\ltTextBlack}{\ltTextRed}%
            \ltSids{#1}{#2}{#3}{#4}{#5}{#6}%
            }{%
            \ltSidsFormat{\ltTextBlack}{\ltTextRed}%
            \ltSids{#1}{#2}{#3}{#4}%
            }%
        }%
    }%
    \ltSidsFormatReset%
}
\DeclareDocumentCommand\ltRubricHymn{m m m m g g g g} {%
    \ltSidsFormatReset%
    {\global\def\sidOneFormat{#1}%
        \IfValueTF {#7}{%
            \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextBlack}{\ltTextBlack}%
            \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
        }{%
            \IfValueTF {#5}{%
            \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextBlack}%
            \ltSids{#1}{#2}{#3}{#4}{#5}{#6}%
            }{%
            \ltSidsFormat{\ltTextRed}{\ltTextBlack}%
            \ltSids{#1}{#2}{#3}{#4}%
            }%
        }%
    }%
    \ltSidsFormatReset%
}
\DeclareDocumentCommand\ltStichos{m m m m g g g g} {%
    \ltSidsFormatReset%
    {\global\def\sidOneFormat{#1}%
        \IfValueTF {#7}{%
            \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextBlack}{\ltTextRed}%
            \ltSids{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
        }{%
            \IfValueTF {#5}{%
            \ltSidsFormat{\ltTextRed}{\ltTextBlack}{\ltTextRed}%
            \ltSids{#1}{#2}{#3}{#4}{#5}{#6}%
            }{%
            \ltSidsFormat{\ltTextRed}{\ltTextBlack}%
            \ltSids{#1}{#2}{#3}{#4}%
            }%
        }%
    }%
    \ltSidsFormatReset%
}

% Takes three argument: left, center, right
% and outputs them as columns
\newcommand\ltFormatThree[3]{%
    {\IfStrEqCase{\pgfkeysvalueof{\my/current/cols}}{%
    {1}{%  output one column    
			\ltTypeography{}%
			#1
            \ltTempTypeographyDefault%
        }%
    {2}{% output two columns
        \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
        \mysloppy%
        \begin{paracol}{2}%
        	\begin{leftcolumn}%
			\ltTypeography{}%
			#1
            \ltTempTypeographyDefault%
            \end{leftcolumn}%          
        	\begin{rightcolumn}%
			\ltTypeography{}%
			#3
            \ltTempTypeographyDefault%
            \end{rightcolumn}%          
        \end{paracol}%
    }%
    {3}{% output three columns
        \colseprulecolor{\pgfkeysvalueof{\my/column/separator/rule/color}}%
        \mysloppy%
        \begin{paracol}{3}%
        	\begin{nthcolumn}{0}%
			\ltTypeography{}%
			#1
            \ltTempTypeographyDefault%
            \end{nthcolumn}%          
        	\begin{nthcolumn}{1}%
			\ltTypeography{}%
			#2
            \ltTempTypeographyDefault%
            \end{nthcolumn}%          
        	\begin{nthcolumn}{2}%
			\ltTypeography{}%
			#3
            \ltTempTypeographyDefault%
            \end{nthcolumn}%          
        \end{paracol}%
    }%
}[]%
}%
}

% load last of all
\ifbool{hyphenate}{%
\usepackage[main=english,greek,french]{babel}%
}{}%
\ifbool{clearbabel}{%
\usepackage[main=english,greek,french]{babel}%
}{}%

\newcommand\ltDebugOn{%
\itDebugOn{}
}
\newcommand\ltDebugOff{%
\itDebugOff{}
}

\endinput

